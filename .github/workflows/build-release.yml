name: Build Debug APK (Test)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies
        run: npm install

      # ğŸŸ¢ ä¿®å¤ TS6305 æŠ¥é”™ï¼šä¸´æ—¶åˆ›å»ºä¸€ä¸ªåªåŒ…å« src çš„ tsconfig
      # è¿™æ · build å°±ä¸ä¼šå› ä¸ºå®ƒå»æ£€æŸ¥ vite.config.ts è€ŒæŠ¥é”™äº†
      - name: Fix TS Config & Build
        run: |
          echo '{
            "compilerOptions": {
              "target": "ES2020",
              "useDefineForClassFields": true,
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "module": "ESNext",
              "skipLibCheck": true,
              "moduleResolution": "bundler",
              "allowImportingTsExtensions": true,
              "resolveJsonModule": true,
              "isolatedModules": true,
              "noEmit": true,
              "jsx": "react-jsx",
              "strict": true,
              "noUnusedLocals": false,
              "noUnusedParameters": false,
              "noFallthroughCasesInSwitch": true
            },
            "include": ["src"],
            "exclude": ["node_modules", "dist", "vite.config.ts", "server.js"]
          }' > tsconfig.json
          
          # å¼€å§‹æ„å»ºç½‘é¡µ
          npm run build

      - name: Setup Capacitor
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          
          # è‡ªåŠ¨åˆ›å»ºå®‰å“å·¥ç¨‹
          if [ ! -d "android" ]; then
            npx cap add android
          fi
          
          # åŒæ­¥èµ„æº
          npx cap copy android
          npx cap sync android

      - name: Build Debug APK
        run: |
          cd android
          chmod +x gradlew
          # ğŸŸ¢ å…³é”®ï¼šæ„å»º Debug åŒ…ï¼ˆè‡ªå¸¦ç­¾åï¼Œå¯ç›´æ¥å®‰è£…ï¼‰
          ./gradlew assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: UniStream-Debug-Installable
          # å¯¼å‡º Debug åŒ…
          path: android/app/build/outputs/apk/debug/*.apk
